<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Simple Live Chat</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            background: #f4f6f8;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .chat-app {
            width: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .1);
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .header select {
            width: 100%;
            margin-bottom: 8px;
            padding: 8px;
        }

        .chat {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #fafafa;
        }

        .message {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .me {
            background: #4f46e5;
            color: white;
            margin-left: auto;
        }

        .them {
            background: #e5e7eb;
            color: #111;
            margin-right: auto;
        }

        .footer {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
        }

        .footer input {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .footer button {
            margin-left: 8px;
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }

        .send-btn {
            background: #4f46e5;

        }

        .reset-btn {
            background: #e11d48;
        }
    </style>
</head>

<body>

    <div class="chat-app">
        <div class="header">
            <label>Me</label>
            <select id="me"></select>
            <label>Chat with</label>
            <select id="them"></select>
        </div>

        <div id="chat" class="chat"></div>

        <div class="footer">
            <input id="message" placeholder="Type a message..." />
            <button class="send-btn" onclick="sendMessage()">Send</button>
        </div>

        <div class="footer">
            <button class="reset-btn" onclick="resetChat()">Reset</button>
        </div>
    </div>

    <script>
        let users = [];
        let ws;
        const meSelect = document.getElementById("me");
        const themSelect = document.getElementById("them");
        const chatDiv = document.getElementById("chat");

        async function loadUsers() {
            users = await (await fetch("users.php")).json();
            meSelect.innerHTML = themSelect.innerHTML = "";
            users.forEach(u => {
                meSelect.add(new Option(u.username, u.id));
                themSelect.add(new Option(u.username, u.id));
            });
            if (users.length >= 2) {
                meSelect.value = users[0].id;
                themSelect.value = users[1].id;
            }

            connectWebSocket();

            // Load past messages so they persist after refresh
            await loadMessages();
        }

        async function loadMessages() {
            if (!meSelect.value || !themSelect.value) return;
            const res = await fetch(`fetch.php?me=${meSelect.value}&them=${themSelect.value}`);
            const messages = await res.json();
            chatDiv.innerHTML = "";
            messages.forEach(m => addMessage(m.sender_id, m.message));
        }

        function connectWebSocket() {
            ws = new WebSocket("ws://localhost:8080");
            ws.onopen = () => console.log("Connected to WebSocket server");
            ws.onmessage = e => {
                const data = JSON.parse(e.data);
                addMessage(data.sender_id, data.message);
            };
            ws.onclose = () => {
                console.log("Disconnected. Reconnecting...");
                setTimeout(connectWebSocket, 2000);
            };
        }

        function sendMessage() {
            const sender_id = Number(meSelect.value);
            const receiver_id = Number(themSelect.value);
            const message = document.getElementById("message").value;
            if (!message || sender_id === receiver_id) return;

            ws.send(JSON.stringify({ sender_id, receiver_id, message }));
            document.getElementById("message").value = "";
        }

        function addMessage(sender_id, message) {
            // convert sender_id to number
            sender_id = Number(sender_id);

            const user = users.find(u => Number(u.id) == sender_id); // compare numbers
            if (!user) return;

            const div = document.createElement("div");
            div.className = "message " + (sender_id == Number(meSelect.value) ? "me" : "them");
            div.textContent = user.username + ": " + message;
            chatDiv.appendChild(div);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }


        async function resetChat() {
            await fetch("reset.php", { method: "POST" });
            chatDiv.innerHTML = "";
        }

        loadUsers();
    </script>

</body>

</html>